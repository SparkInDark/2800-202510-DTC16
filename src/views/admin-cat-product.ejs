<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="/style/style.css" />
    <link rel="stylesheet" href="/style/admin.css" />
</head>
<body>
    <%- include('component/top-navbar.ejs') %>

    <div class="container py-3">
        <h2>Manage Products</h2>
        <form method="POST" action="/admin/cat/product/add" class="mb-3">
            <div class="input-group">
                <input name="name" placeholder="Product Name" class="form-control" required />
                <select name="category_slug" class="form-select" required>
                    <% categories.forEach(cat => { %>
                        <option value="<%= cat.slug %>"><%= cat.name %></option>
                    <% }) %>
                </select>
                <button type="submit" class="btn btn-success">Add</button>
            </div>
        </form>
        <ul class="list-group">
            <% products.forEach(p => { %>
                <li class="list-group-item d-flex justify-content-between align-items-center" id="prod-<%= p._id %>">
                    <form method="POST" action="/admin/cat/product/<%= p._id %>/edit" class="d-flex flex-grow-1 align-items-center" onsubmit="return handleProductConfirm('<%= p._id %>', event)">
                        <input name="name" value="<%= p.name %>" class="form-control form-control-sm" id="name-<%= p._id %>" />
                        <select name="category_slug" class="form-select form-select-sm mx-1" id="cat-<%= p._id %>">
                            <% categories.forEach(cat => { %>
                                <option value="<%= cat.slug %>" <%= cat.slug === p.category_slug ? 'selected' : '' %>><%= cat.name %></option>
                            <% }) %>
                        </select>
                        <button type="button" class="btn btn-danger btn-sm ms-2" id="delbtn-<%= p._id %>" onclick="markProductDeleted('<%= p._id %>')">Delete</button>
                        <button type="submit" class="btn btn-primary btn-sm ms-2" id="confbtn-<%= p._id %>">Confirm</button>
                        <input type="hidden" name="delete" value="0" id="deleteflag-<%= p._id %>">
                    </form>
                </li>
            <% }) %>
        </ul>
    </div>


    <%- include('component/bottom-navbar-admin.ejs') %>
    <script src="/script/profile-dropdown.js"></script>
    <script>
        function markProductDeleted(prodId) {
            // Mark as pending deletion visually
            document.getElementById('prod-' + prodId).classList.add('bg-warning-subtle', 'text-muted');
            document.getElementById('name-' + prodId).setAttribute('readonly', true);
            document.getElementById('cat-' + prodId).setAttribute('disabled', true);

            // Change Delete button appearance/text and disable it
            var delBtn = document.getElementById('delbtn-' + prodId);
            delBtn.innerText = 'Pending';
            delBtn.classList.remove('btn-danger');
            delBtn.classList.add('btn-warning');
            delBtn.disabled = true;

            // Enable Confirm button, set delete flag
            document.getElementById('confbtn-' + prodId).disabled = false;
            document.getElementById('deleteflag-' + prodId).value = "1";
        }

        // Prevent accidental submit unless confirming deletion or editing
        function handleProductConfirm(prodId, event) {
            // If delete flag is set to 1, allow submit (for deletion)
            if (document.getElementById('deleteflag-' + prodId).value === "1") {
                return true;
            }
            // Otherwise, allow normal edit submit
            return true;
        }
    </script>
</body>
</html>