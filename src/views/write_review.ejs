<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Write Review</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="/style/style.css" />
</head>

<body class="bg-gray-100 text-gray-800">
    <%- include('component/top-navbar.ejs') %>



    <form id="review-form" action="/write-review" method="POST" enctype="multipart/form-data"
          class="bg-white p-6 mt-24 mx-auto max-w-2xl rounded-lg shadow space-y-5">

        <!-- Category Selection -->
        <div>
            <label for="category-select" class="font-semibold">Select Category</label>
            <select id="category-select" name="category_slug" class="w-full p-2 border rounded"
                    onchange="onCategoryChange()">
                <option value="">-- Choose a category --</option>
                <% categories.forEach(cat => { %>
                    <option value="<%= cat.slug %>" <%= category_slug === cat.slug ? 'selected' : '' %>><%= cat.name %></option>
                <% }) %>
            </select>
        </div>

        <!-- Product Selection -->
        <div>
            <label for="product-select" class="font-semibold">Select Product</label>
            <select id="product-select" name="product_slug" class="w-full p-2 border rounded"
                    <%= !category_slug ? 'disabled' : '' %>
                    onchange="onProductChange()">
                <option value="">-- Choose a product --</option>
                <% products.forEach(prod => { %>
                    <option value="<%= prod.slug %>" <%= product_slug === prod.slug ? 'selected' : '' %>><%= prod.name %></option>
                <% }) %>
            </select>
        </div>


        <!-- Only show the rest of the form if product is selected -->
        <% if (product_slug) { %>

            <!-- Hidden user_email -->
            <input type="hidden" name="user_email" value="<%= user_email %>">

            <!-- 星级评分 -->
            <div class="review-star-rating" id="review-star-rating">
                <button type="button" class="review-star" aria-label="1 star">★</button>
                <button type="button" class="review-star" aria-label="2 stars">★</button>
                <button type="button" class="review-star" aria-label="3 stars">★</button>
                <button type="button" class="review-star" aria-label="4 stars">★</button>
                <button type="button" class="review-star" aria-label="5 stars">★</button>
            </div>
            <input type="hidden" name="review_rating" id="review-rating-value" value="0" />



            <!-- Review Text -->
            <textarea name="review_text" rows="5" placeholder="Write your review here..."
                      class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-400"
                      required></textarea>



            <!-- 上传图片 (up to 4) -->
            <div class="reviewimg-upload-section">
                <label class="reviewimg-label">Upload Photos (up to 4)</label>
                <div id="reviewimg-grid" class="reviewimg-grid">
                    <% for (let i = 0; i < 4; i++) { %>
                        <div
                                class="reviewimg-slot"
                                onclick="reviewimgOpenFileDialog(<%= i %>)"
                                id="reviewimg-slot-<%= i %>"
                        >
                            <!-- Image preview or placeholder -->
                            <img
                                    src=""
                                    alt="Preview"
                                    class="reviewimg-img-preview reviewimg-hidden"
                                    id="reviewimg-img-preview-<%= i %>"
                            />
                            <span class="reviewimg-placeholder" id="reviewimg-placeholder-<%= i %>">+</span>
                            <!-- X button for soft-delete -->
                            <button
                                    type="button"
                                    onclick="event.stopPropagation(); reviewimgMarkForDelete(<%= i %>);"
                                    class="reviewimg-delete-btn reviewimg-hidden"
                                    id="reviewimg-delete-<%= i %>"
                            >
                                &times;
                            </button>
                            <!-- Pending overlay -->
                            <div
                                    class="reviewimg-pending-overlay reviewimg-hidden"
                                    id="reviewimg-pending-<%= i %>"
                            >Pending…</div>
                            <!-- Hidden file input for each slot -->
                            <input type="file" name="review_image_0" id="reviewimg-file-input-0" ... />
                            <input type="file" name="review_image_1" id="reviewimg-file-input-1" ... />
                            <input type="file" name="review_image_2" id="reviewimg-file-input-2" ... />
                            <input type="file" name="review_image_3" id="reviewimg-file-input-3" ... />
                            <!-- Hidden soft-delete flag -->
                            <input
                                    type="hidden"
                                    name="delete_image_<%= i %>"
                                    id="reviewimg-delete-flag-<%= i %>"
                                    value="false"
                            />
                        </div>
                    <% } %>
                </div>
                <p class="reviewimg-help-text">Click a box to add a photo. Click × to remove. Max 4 images.</p>
            </div>


            <!-- Submit -->
            <button type="submit"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded transition duration-200">
                Submit Review
            </button>


        <% } %>
    </form>



    <%- include('component/bottom-navbar.ejs') %>
    <script src="/script/profile-dropdown.js"></script>
    <script>

        document.addEventListener('DOMContentLoaded', function() {
            // Wrap js insdie a DOM to fix issue
            //  - use addEventListener (or access .addEventListener on an element) before the DOM has created those elements.

            // Dynamic selection category and product

            window.onCategoryChange = function() {
                const cat = document.getElementById('category-select').value;
                window.location.href = '/write-review?category_slug=' + encodeURIComponent(cat);
            }
            window.onProductChange = function() {
                const cat = document.getElementById('category-select').value;
                const prod = document.getElementById('product-select').value;
                window.location.href = '/write-review?category_slug=' + encodeURIComponent(cat) + '&product_slug=' + encodeURIComponent(prod);
            }


            window.reviewimgOpenFileDialog = function(idx) {
                if (document.getElementById('reviewimg-pending-' + idx).classList.contains('reviewimg-flex')) return;
                document.getElementById('reviewimg-file-input-' + idx).click();
            }
            window.reviewimgMarkForDelete = function(idx) {
                document.getElementById('reviewimg-pending-' + idx).classList.remove('reviewimg-hidden');
                document.getElementById('reviewimg-pending-' + idx).classList.add('reviewimg-flex');
                document.getElementById('reviewimg-img-preview-' + idx).classList.add('reviewimg-hidden');
                document.getElementById('reviewimg-delete-' + idx).classList.add('reviewimg-hidden');
                document.getElementById('reviewimg-delete-flag-' + idx).value = 'true';
            }


            // Handle image related behavior in review table

            const reviewimgMaxImages = 4;

            for (let i = 0; i < reviewimgMaxImages; i++) {
                const input = document.getElementById('reviewimg-file-input-' + i);
                if (input) {
                    input.addEventListener('change', function (e) {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = function (evt) {
                                document.getElementById('reviewimg-img-preview-' + i).src = evt.target.result;
                                document.getElementById('reviewimg-img-preview-' + i).classList.remove('reviewimg-hidden');
                                document.getElementById('reviewimg-placeholder-' + i).classList.add('reviewimg-hidden');
                                document.getElementById('reviewimg-delete-' + i).classList.remove('reviewimg-hidden');
                                document.getElementById('reviewimg-pending-' + i).classList.add('reviewimg-hidden');
                                document.getElementById('reviewimg-delete-flag-' + i).value = 'false';
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                }
            }

            const reviewForm = document.getElementById('review-form');
            if (reviewForm) {
                reviewForm.addEventListener('submit', function (e) {
                    for (let i = 0; i < reviewimgMaxImages; i++) {
                        if (document.getElementById('reviewimg-delete-flag-' + i) &&
                            document.getElementById('reviewimg-delete-flag-' + i).value === 'true') {
                            document.getElementById('reviewimg-file-input-' + i).value = '';
                        }
                    }
                });
            }


            // Star rating logic
            const ratingInput = document.getElementById('review-rating-value');
            const stars = document.querySelectorAll('#review-star-rating .review-star');
            let currentRating = parseInt(ratingInput.value, 10) || 0;

            function updateStars(rating) {
                stars.forEach((star, i) => {
                    star.classList.toggle('selected', i < rating);
                    star.classList.toggle('active', i < rating);
                });
            }

            stars.forEach((star, idx) => {
                // Click to select rating
                star.addEventListener('click', function() {
                    currentRating = idx + 1;
                    ratingInput.value = currentRating;
                    updateStars(currentRating);
                });
                // Hover effect
                star.addEventListener('mouseenter', function() {
                    updateStars(idx + 1);
                    star.classList.add('hovered');
                });
                // Remove hover effect
                star.addEventListener('mouseleave', function() {
                    updateStars(currentRating);
                    star.classList.remove('hovered');
                });
            });

            // Initialize on load
            updateStars(currentRating);



        });
    </script>

</body>

</html>

