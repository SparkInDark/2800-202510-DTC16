<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Write Review</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="/style/style.css" />
</head>

<body class="bg-gray-100 text-gray-800">
    <%- include('component/top-navbar.ejs') %>

        <!-- 表单区域 -->
        <form action="/submit-reviews" method="POST" enctype="multipart/form-data"
            class="bg-white p-6 mt-24 mx-auto max-w-2xl rounded-lg shadow space-y-5">

            <!-- Hidden product_slug and user_email -->
            <input type="hidden" name="product_slug" value="<%= product_slug %>">
            <input type="hidden" name="user_email" value="<%= user_email %>">

            <!-- 星级评分 -->
            <div class="flex items-center space-x-1 text-2xl text-gray-300" id="star-rating">
                <% for (let i=1; i <=5; i++) { %>
                    <button type="button" data-rating="<%= i %>" class="star hover:scale-110 transition">
                        ★
                    </button>
                    <% } %>
            </div>
            <input type="hidden" name="rating" id="rating-value" value="0" />


            <!-- Review Text -->
            <textarea name="review_text" rows="5" placeholder="Write your review here..."
                      class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-400"
                      required></textarea>



            <!-- 上传图片 (up to 4) -->
            <div class="reviewimg-upload-section">
                <label class="reviewimg-label">Upload Photos (up to 4)</label>
                <div id="reviewimg-grid" class="reviewimg-grid">
                    <% for (let i = 0; i < 4; i++) { %>
                        <div
                                class="reviewimg-slot"
                                onclick="reviewimgOpenFileDialog(<%= i %>)"
                                id="reviewimg-slot-<%= i %>"
                        >
                            <!-- Image preview or placeholder -->
                            <img
                                    src=""
                                    alt="Preview"
                                    class="reviewimg-img-preview reviewimg-hidden"
                                    id="reviewimg-img-preview-<%= i %>"
                            />
                            <span class="reviewimg-placeholder" id="reviewimg-placeholder-<%= i %>">+</span>
                            <!-- X button for soft-delete -->
                            <button
                                    type="button"
                                    onclick="event.stopPropagation(); reviewimgMarkForDelete(<%= i %>);"
                                    class="reviewimg-delete-btn reviewimg-hidden"
                                    id="reviewimg-delete-<%= i %>"
                            >
                                &times;
                            </button>
                            <!-- Pending overlay -->
                            <div
                                    class="reviewimg-pending-overlay reviewimg-hidden"
                                    id="reviewimg-pending-<%= i %>"
                            >Pending…</div>
                            <!-- Hidden file input for each slot -->
                            <input
                                    type="file"
                                    accept="image/*"
                                    class="reviewimg-file-input"
                                    name="review_images"
                                    id="reviewimg-file-input-<%= i %>"
                            />
                            <!-- Hidden soft-delete flag -->
                            <input
                                    type="hidden"
                                    name="delete_image_<%= i %>"
                                    id="reviewimg-delete-flag-<%= i %>"
                                    value="false"
                            />
                        </div>
                    <% } %>
                </div>
                <p class="reviewimg-help-text">Click a box to add a photo. Click × to remove. Max 4 images.</p>
            </div>


            <!-- Submit -->
            <button type="submit"
                class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded transition duration-200">
                Submit Review
            </button>
        </form>

        <%- include('component/bottom-navbar.ejs') %>
    <script src="/script/profile-dropdown.js"></script>
</body>

</html>

<script>
    const reviewimgMaxImages = 4;

    // Open file dialog for the clicked slot
    function reviewimgOpenFileDialog(idx) {
        if (document.getElementById('reviewimg-pending-' + idx).classList.contains('reviewimg-flex')) return; // Don't allow if pending
        document.getElementById('reviewimg-file-input-' + idx).click();
    }

    // Handle file selection and preview
    for (let i = 0; i < reviewimgMaxImages; i++) {
        document.getElementById('reviewimg-file-input-' + i).addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (evt) {
                    document.getElementById('reviewimg-img-preview-' + i).src = evt.target.result;
                    document.getElementById('reviewimg-img-preview-' + i).classList.remove('reviewimg-hidden');
                    document.getElementById('reviewimg-placeholder-' + i).classList.add('reviewimg-hidden');
                    document.getElementById('reviewimg-delete-' + i).classList.remove('reviewimg-hidden');
                    document.getElementById('reviewimg-pending-' + i).classList.add('reviewimg-hidden');
                    document.getElementById('reviewimg-delete-flag-' + i).value = 'false';
                };
                reader.readAsDataURL(file);
            }
        });
    }

    // Mark for soft-delete
    function reviewimgMarkForDelete(idx) {
        document.getElementById('reviewimg-pending-' + idx).classList.remove('reviewimg-hidden');
        document.getElementById('reviewimg-pending-' + idx).classList.add('reviewimg-flex');
        document.getElementById('reviewimg-img-preview-' + idx).classList.add('reviewimg-hidden');
        document.getElementById('reviewimg-delete-' + idx).classList.add('reviewimg-hidden');
        document.getElementById('reviewimg-delete-flag-' + idx).value = 'true';
    }

    // On submit, remove files flagged for delete
    document.querySelector('form').addEventListener('submit', function (e) {
        for (let i = 0; i < reviewimgMaxImages; i++) {
            if (document.getElementById('reviewimg-delete-flag-' + i).value === 'true') {
                document.getElementById('reviewimg-file-input-' + i).value = ''; // Clear file input
            }
        }
    });

</script>