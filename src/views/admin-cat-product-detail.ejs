<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="/style/style.css" />
    <link rel="stylesheet" href="/style/admin.css" />
</head>
<body>
    <%- include('component/top-navbar.ejs') %>

    <div class="container py-3">
        <form method="POST" enctype="multipart/form-data" action="/admin/cat/product-detail">
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between">
                    <select name="product_id" class="form-select form-select-sm w-50" onchange="this.form.submit()">
                        <% products.forEach(p => { %>
                            <option value="<%= p._id %>" <%= p._id == selectedProduct._id ? 'selected' : '' %>><%= p.name %></option>
                        <% }) %>
                    </select>
                    <button type="button" id="softDeleteBtn" class="btn btn-danger btn-sm">Delete Product</button>
                    <input type="hidden" name="delete" id="deleteFlag" value="">
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <label>Category</label>
                        <select name="category_slug" class="form-select form-select-sm">
                            <% categories.forEach(cat => { %>
                                <option value="<%= cat.slug %>" <%= cat.slug === selectedProduct.category_slug ? 'selected' : '' %>><%= cat.name %></option>
                            <% }) %>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label>Product Pictures (max 4):</label>
                        <!-- Hidden input to track deletions -->
                        <input type="hidden" name="images_to_delete" id="imagesToDelete" value="">
                        <div class="product-image-grid mb-2">
                            <% for(let i=0; i<4; i++) { %>
                                <div class="image-slot" id="img-slot-<%= i %>">
                                    <% if(selectedProduct.images[i]) { %>
                                        <div class="img-wrapper" style="position:relative;">
                                            <img src="<%= selectedProduct.images[i] %>"
                                                 alt="Product Image <%= i+1 %>"
                                                 class="product-img-thumb"
                                                 onclick="enlargeImage('<%= selectedProduct.images[i] %>')" />
                                            <button type="button" class="img-delete-btn" onclick="markImageDeleted(<%= i %>)">×</button>
                                            <div class="img-deleted-overlay" id="img-deleted-<%= i %>" style="display:none;">
                                                <span>Deleted</span>
                                            </div>
                                        </div>
                                    <% } else { %>
                                            <label for="new_image_<%= i %>" class="no-pic clickable-upload" style="cursor:pointer;">
                                                <span>＋<br>No Pic</span>
                                                <img id="preview-<%= i %>" style="display:none;max-width:100%;max-height:100%;border-radius:8px;" />
                                            </label>
                                            <input type="file" name="new_image_<%= i %>" id="new_image_<%= i %>" accept="image/*" class="hidden-file-input" style="display:none;" />
                                    <% } %>
                                </div>
                            <% } %>
                        </div>
                    </div>
                    <div class="mb-2">
                        <label>Specs:</label>
                        <% productSpecs.forEach(spec => { %>
                            <div class="input-group mb-1">
                                <span class="input-group-text"><%= spec %></span>
                                <input name="specs[<%= spec %>]" value="<%= (selectedProduct && selectedProduct.specs && selectedProduct.specs[spec]) || '' %>" class="form-control form-control-sm" />
                            </div>
                        <% }) %>
                    </div>
                </div>
            </div>
            <button type="submit" class="btn btn-primary w-100">Confirm Changes</button>
        </form>
    </div>


    <%- include('component/bottom-navbar-admin.ejs') %>
    <script src="/script/profile-dropdown.js"></script>
    <div id="imgLightbox" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.8);z-index:9999;justify-content:center;align-items:center;">
        <img id="lightboxImg" src="" style="max-width:90vw;max-height:90vh;border-radius:8px;box-shadow:0 4px 24px #000;" />
    </div>
    <script>
        // Lightbox enlarge
        function enlargeImage(url) {
            document.getElementById('imgLightbox').style.display = 'flex';
            document.getElementById('lightboxImg').src = url;
        }
        document.getElementById('imgLightbox').onclick = function() {
            this.style.display = 'none';
        };

        // Image preview for uploading before actual confirm
        for (let i = 0; i < 4; i++) {
            const input = document.getElementById('new_image_' + i);
            if (input) {
                input.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file && file.type.startsWith('image/')) {
                        const preview = document.getElementById('preview-' + i);
                        preview.src = URL.createObjectURL(file);
                        preview.style.display = 'block';
                        // Optionally hide the "+" and "No Pic" text
                        preview.previousElementSibling.style.display = 'none';
                    }
                });
            }
        }

        // Array to keep track of images marked for deletion
        let imagesToDelete = [];
        function markImageDeleted(idx) {
            if (!imagesToDelete.includes(idx)) {
                imagesToDelete.push(idx);
                document.getElementById('img-deleted-' + idx).style.display = 'flex';
                document.querySelector('#img-slot-' + idx + ' img').style.opacity = '0.5';
                document.getElementById('imagesToDelete').value = imagesToDelete.join(',');
            }
        }




        // === soft delete whole product ===
        let productPendingDelete = false;

        document.getElementById('softDeleteBtn').addEventListener('click', function() {
            // Mark as pending deletion
            productPendingDelete = true;
            // Visual feedback: gray out form, disable inputs, change button text
            document.querySelector('.card').classList.add('bg-warning-subtle', 'text-muted');
            document.querySelectorAll('input, select, .img-delete-btn').forEach(el => {
                el.setAttribute('readonly', true);
                el.setAttribute('disabled', true);
            });
            this.innerText = 'Pending Deletion';
            this.classList.remove('btn-danger');
            this.classList.add('btn-warning');
            this.disabled = true;
            // Set hidden input so backend knows to delete on confirm
            document.getElementById('deleteFlag').value = "1";
            // Enable the confirm button if it was disabled
            document.querySelector('button[type="submit"]').disabled = false;
        });

        // On form submit, allow deletion if flagged
        document.querySelector('form').addEventListener('submit', function(e) {
            if (productPendingDelete) {
                // Allow submit to proceed with delete=1
                return true;
            }
            // Normal edit: allow as usual
            return true;
        });

    </script>
</body>
</html>